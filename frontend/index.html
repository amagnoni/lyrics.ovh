const express = require("express");
const axios = require("axios");
const cors = require("cors");
const geniusLyrics = require("genius-lyrics-api");

let appApi = express();
let appFrontend = express();
const portApi = 8080;
const portFrontend = 8081;

appApi.use(cors());

// Lyrics fetching function using genius-lyrics-api
async function findLyrics(title, artist) {
  const options = {
    apiKey: process.env.GENIUS_API_KEY || "your_genius_api_key_here", // You'll need to get this from Genius
    title: title,
    artist: artist,
    optimizeQuery: true
  };

  try {
    const lyrics = await geniusLyrics.getLyrics(options);
    return lyrics;
  } catch (error) {
    // Fallback: try without artist optimization
    try {
      const fallbackOptions = {
        apiKey: options.apiKey,
        title: `${title} ${artist}`,
        optimizeQuery: false
      };
      const lyrics = await geniusLyrics.getLyrics(fallbackOptions);
      return lyrics;
    } catch (fallbackError) {
      throw new Error("No lyrics found");
    }
  }
}

appApi.get("/v1/:artist/:title", async function (req, res) {
  if (!req.params.artist || !req.params.title) {
    return res.status(400).send({ error: "Artist or title missing" });
  }
  
  try {
    const lyrics = await findLyrics(req.params.title, req.params.artist);
    res.send({ lyrics: lyrics });
  } catch (e) {
    console.log("Lyrics error:", e.message);
    res.status(404).send({ error: "No lyrics found" });
  }
});

appApi.get("/suggest/:term", async function (req, res) {
  try {
    const response = await axios.get(
      `http://api.deezer.com/search?limit=15&q=${encodeURIComponent(req.params.term)}`,
      { timeout: 5000 }
    );
    res.send(response.data);
  } catch (error) {
    console.log("Suggestion error:", error.message);
    res.status(500).send({ error: "Search suggestions unavailable" });
  }
});

appFrontend.use(express.static("frontend"));

appApi.listen(portApi, function () {
  console.log("API listening on port " + portApi);
});

appFrontend.listen(portFrontend, function () {
  console.log("Frontend listening on port " + portFrontend);
});